---
- meta: flush_handlers

- name: Enable fsync for the virtual machine disk
  shell: zfs set sync=standard "$(vmadm get {{ zone_uuid }} | json {% if zone_brand == 'kvm' %}disks.0.{% endif %}zfs_filesystem)"
  when: vm_fsync_off | default(true)
  ignore_errors: True

- name: Inspect the VM before final image preparation begins
  pause:
  when: image_debug is defined and image_debug

- name: Register OS information (CentOS)
  shell: cat /etc/redhat-release
  register: os_info_centos
  when: ansible_distribution == "CentOS"

- name: Register OS information (SmartOS)
  shell: cat /etc/pkgsrc_version
  register: os_info_smartos
  when: ansible_distribution == "SmartOS"

- name: Prepare virtual machine for snapshotting (CentOS)
  shell: |
    rm -f /root/.ssh/authorized_keys
    prepare-image
  when: ansible_distribution == "CentOS"

- name: Prepare virtual machine for snapshotting (SmartOS)
  shell: |
    rm -f /root/.ssh/authorized_keys
    export yn_start="y"
    export yn_nfs="y"
    export yn_subips="y"
    export yn_halt="n"
    sm-prepare-image
  when: ansible_distribution == "SmartOS"

- name: Display OS information (CentOS)
  debug:
    var: os_info_centos
  when: ansible_distribution == "CentOS"

- name: Display OS information (SmartOS)
  debug:
    var: os_info_smartos
  when: ansible_distribution == "SmartOS"
