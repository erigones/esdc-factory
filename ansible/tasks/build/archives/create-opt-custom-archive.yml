- name: Clean old /opt/custom archive
  file: state=absent path=/var/tmp/opt-custom-archive

- name: Bootstrap empty /opt/custom archive
  file: state=directory path=/var/tmp/opt-custom-archive/opt

- name: Copy new content
  copy:
    src=files/archives/opt-custom
    dest=/var/tmp/opt-custom-archive/opt/custom
    owner=root
    group=root
    mode=0644
    directory_mode=0755
    follow=no

- name: Mark SMF methods executable
  shell: chmod -R 755 /var/tmp/opt-custom-archive/opt/custom/method/

- name: Create opt-src tarball {{ pkg_name }}{{ pkg_ext }}
  shell: chdir=/var/tmp/opt-custom-archive gtar -czvf "/var/tmp/{{ pkg_name }}{{ pkg_ext }}" opt

- name: Save monitoring tarball {{ save_dir }}/{{ pkg_name }}{{ pkg_ext }}
  fetch: src="/var/tmp/{{ pkg_name }}{{ pkg_ext }}" dest="{{ save_dir }}/" flat=yes fail_on_missing=yes validate_checksum=yes

- name: Clean old /opt/custom archive
  file: state=absent path=/var/tmp/opt-custom-archive

